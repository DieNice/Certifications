## Табличные пространства
**Табличное пространство** — это место, где PostgreSQL хранит данные. Табличное пространство PostgreSQL позволяет легко перемещать данные в разные физически места с помощью простых команд. По умолчанию PostgreSQL предоставляет два табличных пространства: **pg_default** для хранения пользовательских данных и **pg_global** для хранения системных данных.

![](https://www.postgresqltutorial.com/wp-content/uploads/2019/05/postgresql-tablespace.png)
Табличные пространства в Postgres позволяют администраторам организовать логику размещения файлов объектов базы данных в файловой системе. К однажды созданному табличному пространству можно обращаться по имени на этапе создания объектов.

Табличные пространства позволяют администратору управлять дисковым пространством для инсталляции Postgres. Это полезно минимум по двум причинам. Во-первых, это нехватка места в разделе, на котором был инициализирован кластер и невозможность его расширения. Табличное пространство можно создать в другом разделе и использовать его до тех пор, пока не появится возможность переконфигурирования системы.

Во-вторых, табличные пространства позволяют администраторам оптимизировать производительность согласно бизнес-процессам, связанным с объектами базы данных. Например, часто используемый индекс можно разместить на очень быстром и надёжном, но дорогом SSD-диске. В то же время таблица с архивными данными, которые редко используются и скорость к доступа к ним не важна, может быть размещена в более дешёвом и медленном хранилище.

**Пример**:
**Задача.** На HDD перестало хватать места под базу данных. Было принято решение добавить дополнительный HDD и перенести на него хранение одной таблицы cdr_old нашей базы данных.

**Решение.** Создаётся новое табличное пространство и в него переносится таблица cdr_old вместе с её индексами.

1.  Создадим новую (обязательную пустую) директорию на новом HDD. Права на директорию должны принадлежать пользователю, которому принадлежит сервер PostgreSQL.
    
    mkdir -p /var/log/VAR/LIB/psql/tspace_old_cdr
    chown -R postgres:postgres /var/log/VAR/LIB/psql/
    
2.  Создание табличного пространства tspace_old_cdr.
    
    CREATE TABLESPACE tablespace_name [ OWNER user_name ] LOCATION 'directory'
    
    tablespace_name - имя создаваемого табличного пространства. Имя не может начинаться с pg_ , такие имена зарезервированы для системных табличных пространств. user_name - имя пользователя владельца. directory - каталог, который будет использоваться для табличного пространства. В нашем случае команда примет вид:
    
    CREATE TABLESPACE tspace_old_cdr LOCATION '/var/log/VAR/LIB/psql/tspace_old_cdr';
    
3.  Перемещение таблицы cdr_old в новое табличное пространство. Перемещение табличных пространств означает простое (блочное) копирование данных на новое место HDD. Чем больше таблица, тем больше времени займет копирование. На время копирования таблица полностью блокируется (ACCESSEXCLUSIVELOCK).
    
    ALTER TABLE cdr_old SET TABLESPACE tspace_old_cdr;
    
    Перемещение индекса таблицы в новое табличное пространство.
    
    ALTER INDEX i_cdr_out SET TABLESPACE tspace_old_cdr;
    
    После окончания копирования, при помощи ключа \d, можно посмотреть в каком табличном пространстве находится таблица и ее индексы. Вывод команды ниже показывает, что сама таблица cdr_old и её индекс i_cdr_out находятся в одном табличном пространстве tspace_old_cdr, а три других индекса в табличном пространстве по умолчанию.
```
# \d cdr_old
...
Indexes:
	"cdr_new_pk" PRIMARY KEY, btree (id)
	"i_cdr_in" btree (begin_time, src_peer_id, cause_local)
	"i_cdr_out" btree (begin_time, dst_peer_id, cause_local), tablespace "tspace_old_cdr"
	"i_cdr_pairs" btree (begin_time)
Tablespace: "tspace_old_cdr"
``` 

Источники:
1. https://postgrespro.ru/docs/postgrespro/9.5/manage-ag-tablespaces
2. https://sysadminium.ru/tablichnye_prostranstva_v_postgresql/
3. https://postgrespro.ru/docs/postgrespro/9.5/manage-ag-tablespaces
